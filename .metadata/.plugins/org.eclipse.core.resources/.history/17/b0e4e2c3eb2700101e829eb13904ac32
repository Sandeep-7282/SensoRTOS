#include "stm32f103xb.h"
#include "uart-driver.h"
#include "gpio-driver.h"
#include "dht22-driver.h"  // Same driver for DHT22
#include <string.h>

char rx_buffer[16];
uint8_t idx = 0;
uint8_t temperature, humidity;

int main(void) {
    UART1_Init();
    GPIO_Init();
    DHT22_Init();

    UART1_SendString("Sensor and Actuator Demo Initialized\r\n");

    while (1) {
        // Read temperature and humidity
        if (DHT22_Read(&temperature, &humidity)) {
            // Report sensor data
            char temp_str[32], humidity_str[32];
            snprintf(temp_str, sizeof(temp_str), "Temperature: %d C\r\n", temperature);
            snprintf(humidity_str, sizeof(humidity_str), "Humidity: %d %%\r\n", humidity);
            UART1_SendString(temp_str);
            UART1_SendString(humidity_str);

            // Control Buzzer based on temperature (example: > 30Â°C)
            if (temperature > 30) {
                BUZZER_ON();
                UART1_SendString("Buzzer ON\r\n");
            } else {
                BUZZER_OFF();
                UART1_SendString("Buzzer OFF\r\n");
            }
        }

        delay(1000000);  // Delay between readings (e.g., 1 second)
    }
}
